<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢¨è¯­æ™ºå­¦ AI - ä½ çš„æ™ºèƒ½å­¦ä¹ ä¼™ä¼´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        // å¢å¼ºç‰ˆæœºæ¢°äººåŠ©æ‰‹ç±»
        class EnhancedRobotAssistant {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                if (!this.container) return;

                // åˆ›å»ºæœºæ¢°äººå…ƒç´  - ä½¿ç”¨å›¾ç‰‡
                this.container.innerHTML = `
                    <div class="robot-image-container">
                        <img src="https://imgur.la/images/2025/06/08/AB9D66DF1072932D11D8D306BE46693C.jpg" alt="å°åŠ©æ‰‹" class="robot-image">
                    </div>
                    <div class="robot-message"></div>
                `;

                // é…ç½®
                this.config = {
                    position: 'right-middle',
                    reactions: {
                        positive: true,
                        negative: true,
                        encouragement: true
                    },
                    messages: [
                        "éœ€è¦å¸®åŠ©å—ï¼Ÿéšæ—¶é—®æˆ‘å“¦~",
                        "ç‚¹å‡»æˆ‘å¯ä»¥è·å¾—å¸®åŠ©å“¦~",
                        "æˆ‘åœ¨è¿™é‡Œé™ªä½ å­¦ä¹ å‘¢ï¼",
                        "æœ‰ä»€ä¹ˆé—®é¢˜å°½ç®¡é—®æˆ‘å§ï¼"
                    ],
                    // æ–°å¢å­¦ä¹ ç›¸å…³æç¤ºè¯
                    learningPrompts: {
                        forgetReview: "æ ¹æ®é—å¿˜æ›²çº¿ï¼Œå»ºè®®ä½ ç°åœ¨å¤ä¹ : ",
                        multimodalTip: "è¯•è¯•å¤šæ¨¡æ€å­¦ä¹ ï¼šå…ˆå¬éŸ³é¢‘å†çœ‹æ–‡æœ¬æ•ˆæœæ›´å¥½å“¦",
                        emotionSupport: {
                            anxious: "æ£€æµ‹åˆ°ä½ æœ‰äº›ç„¦è™‘ï¼Œæ·±å‘¼å¸æ”¾æ¾ä¸€ä¸‹~",
                            frustrated: "é‡åˆ°å›°éš¾å¾ˆæ­£å¸¸ï¼Œä¼‘æ¯ä¸€ä¸‹å†ç»§ç»­å§",
                            confident: "ä½ çš„å­¦ä¹ çŠ¶æ€å¾ˆæ£’ï¼Œç»§ç»­ä¿æŒï¼"
                        }
                    },
                    // çŸ¥è¯†è¿½è¸ªçŠ¶æ€
                    knowledgeState: {}
                };

                // è®¾ç½®åˆå§‹ä½ç½®
                this.setPosition(this.config.position);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                this.container.addEventListener('click', () => {
                    this.showRandomMessage(3000);
                });

                // åˆå§‹åŠ¨ç”»
                this.playHappyAnimation();
                
                // åˆå§‹åŒ–é—å¿˜æ›²çº¿å¤ä¹ æé†’
                this.initForgettingCurveReminder();
            }

            // è®¾ç½®ä½ç½®
            setPosition(position) {
                const positions = {
                    'right-middle': { 
                        right: '0',
                        top: '50%',
                        transform: 'translateY(-50%)'
                    },
                    'bottom-right': { right: '20px', bottom: '20px' },
                    'bottom-left': { left: '20px', bottom: '20px' },
                    'top-right': { right: '20px', top: '20px' },
                    'top-left': { left: '20px', top: '20px' }
                };
                
                if (positions[position]) {
                    Object.assign(this.container.style, {
                        position: 'fixed',
                        ...positions[position],
                        zIndex: '1000',
                        pointerEvents: 'auto'
                    });
                    this.config.position = position;
                }
            }

            // åˆå§‹åŒ–é—å¿˜æ›²çº¿å¤ä¹ æé†’
            initForgettingCurveReminder() {
                // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å­¦ä¹ è®°å½•
                const learningRecords = JSON.parse(localStorage.getItem('learningRecords') || '[]');
                if (learningRecords.length > 0) {
                    // è®¡ç®—éœ€è¦å¤ä¹ çš„å†…å®¹
                    const now = new Date();
                    const toReview = learningRecords.filter(record => {
                        const lastReview = new Date(record.lastReview);
                        const hoursPassed = (now - lastReview) / (1000 * 60 * 60);
                        
                        // è‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿å…³é”®æ—¶é—´ç‚¹ï¼š20åˆ†é’Ÿ, 1å°æ—¶, 9å°æ—¶, 1å¤©, 2å¤©, 6å¤©, 31å¤©
                        const reviewIntervals = [0.33, 1, 9, 24, 48, 144, 744];
                        const nextReviewIndex = Math.min(record.reviewCount, reviewIntervals.length - 1);
                        return hoursPassed >= reviewIntervals[nextReviewIndex];
                    });
                    
                    if (toReview.length > 0) {
                        setTimeout(() => {
                            const reviewList = toReview.map(r => r.topic).join(', ');
                            this.showMessage(`${this.config.learningPrompts.forgetReview}${reviewList}`, 5000);
                        }, 3000);
                    }
                }
            }

            // æ›´æ–°çŸ¥è¯†è¿½è¸ªçŠ¶æ€
            updateKnowledgeState(topic, masteryLevel) {
                if (!this.config.knowledgeState[topic]) {
                    this.config.knowledgeState[topic] = {
                        mastery: 0,
                        lastPracticed: new Date().toISOString(),
                        reviewCount: 0
                    };
                }
                
                this.config.knowledgeState[topic].mastery = masteryLevel;
                this.config.knowledgeState[topic].lastPracticed = new Date().toISOString();
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                const learningRecords = JSON.parse(localStorage.getItem('learningRecords') || '[]');
                const existingRecord = learningRecords.find(r => r.topic === topic);
                
                if (existingRecord) {
                    existingRecord.mastery = masteryLevel;
                    existingRecord.lastReview = new Date().toISOString();
                    existingRecord.reviewCount += 1;
                } else {
                    learningRecords.push({
                        topic,
                        mastery: masteryLevel,
                        lastReview: new Date().toISOString(),
                        reviewCount: 0
                    });
                }
                
                localStorage.setItem('learningRecords', JSON.stringify(learningRecords));
            }

            // æ˜¾ç¤ºéšæœºæ¶ˆæ¯
            showRandomMessage(duration = 3000) {
                const randomIndex = Math.floor(Math.random() * this.config.messages.length);
                this.showMessage(this.config.messages[randomIndex], duration);
            }

            // æ˜¾ç¤ºæ¶ˆæ¯
            showMessage(message, duration = 3000) {
                // åˆ›å»ºæˆ–è·å–æ¶ˆæ¯å…ƒç´ 
                if (!this.messageElement) {
                    this.messageElement = this.container.querySelector('.robot-message');
                }
                
                this.messageElement.textContent = message;
                this.messageElement.style.display = 'block';
                
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                this.startTalkingAnimation();
                
                if (duration > 0) {
                    setTimeout(() => {
                        this.hideMessage();
                        this.stopTalkingAnimation();
                    }, duration);
                }
            }

            hideMessage() {
                if (this.messageElement) {
                    this.messageElement.style.display = 'none';
                }
            }

            // å¼€å§‹è¯´è¯åŠ¨ç”»
            startTalkingAnimation() {
                const image = this.container.querySelector('.robot-image');
                image.classList.add('talk-animation');
            }

            // åœæ­¢è¯´è¯åŠ¨ç”»
            stopTalkingAnimation() {
                const image = this.container.querySelector('.robot-image');
                image.classList.remove('talk-animation');
            }

            // å“åº”æ­£é¢åé¦ˆ
            reactPositive() {
                if (this.config.reactions.positive) {
                    this.showMessage('åšå¾—å¾ˆå¥½ï¼', 2000);
                    this.playHappyAnimation();
                }
            }

            // å“åº”è´Ÿé¢åé¦ˆ
            reactNegative() {
                if (this.config.reactions.negative) {
                    this.showMessage('å†è¯•ä¸€æ¬¡å§ï¼', 2000);
                    this.playSadAnimation();
                }
            }

            // é¼“åŠ±ç”¨æˆ·
            encourage() {
                if (this.config.reactions.encouragement) {
                    this.showMessage('ä½ å¯ä»¥çš„ï¼åŠ æ²¹ï¼', 2000);
                    this.playHappyAnimation();
                }
            }

            // æ’­æ”¾å¼€å¿ƒåŠ¨ç”»
            playHappyAnimation() {
                const image = this.container.querySelector('.robot-image');
                image.classList.add('happy-animation');
                
                setTimeout(() => {
                    image.classList.remove('happy-animation');
                }, 2000);
            }

            // æ’­æ”¾éš¾è¿‡åŠ¨ç”»
            playSadAnimation() {
                const image = this.container.querySelector('.robot-image');
                image.classList.add('sad-animation');
                
                setTimeout(() => {
                    image.classList.remove('sad-animation');
                }, 2000);
            }

            // ç‚¹å¤´åŠ¨ç”»
            playNodAnimation() {
                const image = this.container.querySelector('.robot-image');
                image.classList.add('nod-animation');
                
                setTimeout(() => {
                    image.classList.remove('nod-animation');
                }, 1000);
            }

            // å“åº”æ¶ˆæ¯ - å¢å¼ºç‰ˆ
            respondToMessage(message, sender, emotion = null) {
                if (sender === 'user') {
                    // åˆ†æç”¨æˆ·æ¶ˆæ¯æƒ…ç»ª
                    const positiveWords = ['è°¢è°¢', 'å¾ˆå¥½', 'å¸®åŠ©', 'å–œæ¬¢', 'æ£’'];
                    const negativeWords = ['é”™è¯¯', 'ä¸æ‡‚', 'ä¸ä¼š', 'å›°éš¾', 'é—®é¢˜'];
                    
                    // æ£€æµ‹æƒ…ç»ªçŠ¶æ€
                    if (emotion) {
                        this.handleEmotionState(emotion);
                    }
                    
                    // æ£€æµ‹å­¦ä¹ å†…å®¹å¹¶æ›´æ–°çŸ¥è¯†çŠ¶æ€
                    this.analyzeLearningContent(message);
                    
                    if (positiveWords.some(word => message.includes(word))) {
                        this.reactPositive();
                    } else if (negativeWords.some(word => message.includes(word))) {
                        this.reactNegative();
                    } else if (Math.random() > 0.7) {
                        this.encourage();
                    }
                    
                    // éšæœºæä¾›å¤šæ¨¡æ€å­¦ä¹ å»ºè®®
                    if (Math.random() > 0.8 && message.includes('å­¦ä¹ ')) {
                        setTimeout(() => {
                            this.showMessage(this.config.learningPrompts.multimodalTip, 3000);
                        }, 2000);
                    }
                } else if (sender === 'ai') {
                    // AIå›å¤æ—¶ç‚¹å¤´
                    this.playNodAnimation();
                }
            }
            
            // å¤„ç†æƒ…ç»ªçŠ¶æ€
            handleEmotionState(emotion) {
                const { anxious, frustrated, confident } = this.config.learningPrompts.emotionSupport;
                
                switch(emotion) {
                    case 'anxious':
                        this.showMessage(anxious, 3000);
                        this.playSadAnimation();
                        break;
                    case 'frustrated':
                        this.showMessage(frustrated, 3000);
                        this.playSadAnimation();
                        break;
                    case 'confident':
                        this.showMessage(confident, 3000);
                        this.playHappyAnimation();
                        break;
                }
            }
            
            // åˆ†æå­¦ä¹ å†…å®¹å¹¶æ›´æ–°çŸ¥è¯†çŠ¶æ€
            analyzeLearningContent(message) {
                // æ£€æµ‹å­¦ä¹ ä¸»é¢˜
                const topics = {
                    vocabulary: ['å•è¯', 'è¯æ±‡', 'vocabulary'],
                    grammar: ['è¯­æ³•', 'grammar'],
                    listening: ['å¬åŠ›', 'listening'],
                    reading: ['é˜…è¯»', 'reading'],
                    writing: ['å†™ä½œ', 'writing']
                };
                
                for (const [topic, keywords] of Object.entries(topics)) {
                    if (keywords.some(keyword => message.includes(keyword))) {
                        // ç®€å•æ¨¡æ‹ŸæŒæ¡ç¨‹åº¦ (å®é™…åº”ç”¨ä¸­åº”è¯¥åŸºäºæ›´å¤æ‚çš„ç®—æ³•)
                        const mastery = Math.min(1, Math.max(0, 
                            Math.random() * 0.3 + 0.5 + (message.length > 30 ? 0.1 : 0)
                        ));
                        
                        this.updateKnowledgeState(topic, mastery);
                        break;
                    }
                }
            }
            
            // è°ƒç”¨æ™ºæ™®APIè·å–æ™ºèƒ½å›å¤
            async getSmartResponse(message) {
                try {
                    const response = await this.callZhipuAPI(message);
                    return response;
                } catch (error) {
                    console.error("è°ƒç”¨æ™ºæ™®APIå‡ºé”™:", error);
                    return "è®©æˆ‘æƒ³æƒ³æ€ä¹ˆå›ç­”ä½ ...";
                }
            }
            
            // è°ƒç”¨æ™ºæ™®API
            async callZhipuAPI(message) {
                const ZHIPU_API_KEY = "fb70a667fee0422ca79519e4fe598cff.JO3wADNEk2VeaPYQ";
                const ZHIPU_API_URL = "https://open.bigmodel.cn/api/paas/v4/chat/completions";
                
                const requestData = {
                    model: "glm-4",
                    messages: [{
                        role: "user",
                        content: message
                    }],
                    temperature: 0.7,
                    max_tokens: 200
                };
                
                const response = await fetch(ZHIPU_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ZHIPU_API_KEY}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            }
        }

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2962FF',
                        secondary: '#1A237E',
                        aiBg: '#F8FAFF',
                        userBg: '#2962FF',
                        accent: '#FF6D00',
                        lightBg: '#F5F7FF',
                        robotBlue: '#4A90E2',
                        robotLightBlue: '#7FB2F0',
                        robotDarkBlue: '#2E5C9A',
                        // æ–°å¢æƒ…æ„Ÿç›¸å…³é¢œè‰²
                        anxious: '#FF6B6B',
                        frustrated: '#FFA502',
                        confident: '#51CF66'
                    },
                    borderRadius: {
                        'none': '0px',
                        'sm': '2px',
                        DEFAULT: '4px',
                        'md': '8px',
                        'lg': '12px',
                        'xl': '16px',
                        '2xl': '20px',
                        '3xl': '24px',
                        'full': '9999px'
                    },
                    fontFamily: {
                        'sans': ['"PingFang SC"', '"Microsoft YaHei"', 'sans-serif'],
                        'content': ['"PingFang SC"', '"Microsoft YaHei"', 'sans-serif']
                    },
                    boxShadow: {
                        'message': '0 2px 8px rgba(0, 0, 0, 0.08)',
                        'input': '0 4px 12px rgba(41, 98, 255, 0.1)',
                        'card': '0 4px 12px rgba(0, 0, 0, 0.05)',
                        'robot': '0 4px 12px rgba(0, 0, 0, 0.15)'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: #F5F7FF;
        }
        
        .message-ai {
            background: #F8FAFF;
            border-radius: 0 16px 16px 16px;
            position: relative;
        }
        
        .message-ai::before {
            content: "";
            position: absolute;
            left: -8px;
            top: 0;
            width: 8px;
            height: 16px;
            background: #F8FAFF;
            clip-path: polygon(0 0, 100% 0, 100% 100%);
        }
        
        .message-user {
            background: linear-gradient(135deg, #2962FF 0%, #1A237E 100%);
            color: white;
            border-radius: 16px 0 16px 16px;
            position: relative;
        }
        
        .message-user::after {
            content: "";
            position: absolute;
            right: -8px;
            top: 0;
            width: 8px;
            height: 16px;
            background: linear-gradient(135deg, #2962FF 0%, #1A237E 100%);
            clip-path: polygon(0 0, 0 100%, 100% 0);
        }
        
        .typing-indicator {
            display: inline-flex;
            align-items: center;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #2962FF;
            border-radius: 50%;
            margin-right: 4px;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        
        .scrollbar-custom::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-track {
            background: rgba(241, 241, 241, 0.5);
            border-radius: 3px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: rgba(136, 136, 136, 0.3);
            border-radius: 3px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
            background: rgba(85, 85, 85, 0.5);
        }
        
        .input-box {
            transition: all 0.2s ease;
            min-height: 48px;
            max-height: 200px;
        }
        
        .input-box:focus {
            box-shadow: 0 0 0 2px rgba(41, 98, 255, 0.2);
        }
        
        .send-btn {
            transition: all 0.2s ease;
        }
        
        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(41, 98, 255, 0.2);
        }
        
        .send-btn:active {
            transform: translateY(0);
        }
        
        .tooltip {
            opacity: 0;
            transition: all 0.2s ease;
            pointer-events: none;
        }
        
        .tooltip-parent:hover .tooltip {
            opacity: 1;
            transform: translateY(0);
        }
        
        .sidebar {
            transition: all 0.3s ease;
            transform: translateX(-100%);
        }
        
        .sidebar-open {
            transform: translateX(0);
        }
        
        .sidebar-overlay {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .sidebar-overlay-open {
            opacity: 1;
            pointer-events: auto;
        }
        
        .welcome-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: 24px 16px;
            box-sizing: border-box;
        }
        
        /* è¾“å…¥æ¡†å®¹å™¨æ ·å¼ */
        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background: white;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: 16px 0;
        }
        
        .input-wrapper {
            padding: 0 16px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* èŠå¤©å†…å®¹åŒºåŸŸ */
        .chat-content-container {
            position: fixed;
            top: 72px; /* é¡¶éƒ¨å¯¼èˆªæ é«˜åº¦ */
            bottom: 150px; /* è¾“å…¥æ¡†åŒºåŸŸé«˜åº¦ */
            left: 0;
            right: 0;
            overflow-y: auto;
            padding: 16px;
        }
        
        .chat-content {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 20px;
        }
        
        /* AIå›å¤æ ·å¼ä¼˜åŒ– */
        .ai-response {
            line-height: 1.6;
            font-size: 15px;
            color: #333;
        }
        
        .ai-response h2, .ai-response h3 {
            margin: 1.2em 0 0.8em;
            font-weight: 600;
            color: #222;
        }
        
        .ai-response p {
            margin-bottom: 1em;
        }
        
        .ai-response ul, .ai-response ol {
            margin: 0.8em 0;
            padding-left: 1.5em;
        }
        
        .ai-response li {
            margin-bottom: 0.5em;
        }
        
        .ai-response blockquote {
            border-left: 3px solid #2962FF;
            padding: 0.5em 1em;
            margin: 1em 0;
            background-color: rgba(41, 98, 255, 0.05);
            color: #555;
        }
        
        .ai-response pre {
            background-color: #f6f8fa;
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1em 0;
        }
        
        .ai-response code {
            font-family: 'Courier New', monospace;
            background-color: rgba(175, 184, 193, 0.2);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 85%;
        }
        
        .ai-response .citation {
            font-size: 0.9em;
            color: #666;
            margin-top: 1em;
        }
        
        .ai-response a {
            color: #2962FF;
            text-decoration: underline;
        }
        
        .ai-response .emoji {
            font-size: 1.2em;
            margin-right: 0.3em;
            vertical-align: middle;
        }
        
        .ai-response .highlight {
            background-color: rgba(255, 215, 0, 0.2);
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }
        
        .ai-response .tip-box {
            background-color: rgba(41, 98, 255, 0.05);
            border-left: 3px solid #2962FF;
            padding: 1em;
            margin: 1em 0;
            border-radius: 0 4px 4px 0;
        }
        
        .ai-response .example-box {
            background-color: rgba(0, 128, 0, 0.05);
            border-left: 3px solid #008000;
            padding: 1em;
            margin: 1em 0;
            border-radius: 0 4px 4px 0;
        }
        
        .ai-response .warning-box {
            background-color: rgba(255, 0, 0, 0.05);
            border-left: 3px solid #FF0000;
            padding: 1em;
            margin: 1em 0;
            border-radius: 0 4px 4px 0;
        }
        
        /* æ–°å¢æƒ…æ„ŸçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .emotion-indicator {
            position: absolute;
            right: 10px;
            top: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .emotion-anxious {
            background-color: #FF6B6B;
            box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.3);
        }
        
        .emotion-frustrated {
            background-color: #FFA502;
            box-shadow: 0 0 0 2px rgba(255, 165, 2, 0.3);
        }
        
        .emotion-confident {
            background-color: #51CF66;
            box-shadow: 0 0 0 2px rgba(81, 207, 102, 0.3);
        }
        
        /* æ–°å¢å¤ä¹ æé†’åŒºåŸŸ */
        .review-reminder {
            background-color: rgba(41, 98, 255, 0.1);
            border-left: 3px solid #2962FF;
            padding: 12px;
            margin: 16px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .review-reminder h4 {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2962FF;
        }
        
        .review-reminder ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .review-reminder li {
            padding: 4px 0;
            display: flex;
            align-items: center;
        }
        
        .review-reminder li:before {
            content: "â€¢";
            color: #2962FF;
            margin-right: 8px;
        }
        
        @media (min-width: 1024px) {
            .sidebar-open ~ .flex-1 .chat-content-container,
            .sidebar-open ~ .flex-1 .input-container {
                left: 256px;
            }
        }
        
        @media (max-width: 640px) {
            .input-wrapper {
                max-width: 100%;
                padding: 0 12px;
            }
            
            .chat-content-container {
                top: 64px;
                bottom: 140px;
                padding: 12px;
            }
            
            .message-ai, .message-user {
                max-width: 90%;
            }
            
            .ai-response {
                font-size: 14px;
            }
        }
        
        /* æ¶ˆæ¯æ ·å¼è°ƒæ•´ */
        .message-ai, .message-user {
            max-width: 75%;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        .typing-indicator {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        /* åŠ©æ‰‹å¡ç‰‡æ ·å¼ */
        .assistant-card {
            transition: all 0.2s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .assistant-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }
        
        .assistant-card.active {
            border-color: #2962FF;
            background-color: rgba(41, 98, 255, 0.05);
        }
        
        /* æ ‡ç­¾æ ·å¼ */
        .tag {
            display: inline-block;
            padding: 0.2em 0.6em;
            font-size: 0.75em;
            border-radius: 9999px;
            background-color: rgba(41, 98, 255, 0.1);
            color: #2962FF;
            margin-right: 0.5em;
            margin-bottom: 0.5em;
        }
        
        /* æœºæ¢°äººåŠ©æ‰‹æ ·å¼ - ä¸è®¡åˆ’ç•Œé¢ä¸€è‡´ */
        #robot-assistant-container {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 80px;
            height: 120px;
            z-index: 1000;
            pointer-events: auto;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .robot-image-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .robot-image {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            border: 2px solid white;
        }
        
        /* æ¶ˆæ¯æ°”æ³¡ - è°ƒæ•´ä½ç½® */
        .robot-message {
            position: absolute;
            right: 100px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 240px;
            font-size: 14px;
            line-height: 1.4;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .robot-message:after {
            content: '';
            position: absolute;
            top: 50%;
            right: -8px;
            transform: translateY(-50%);
            border-width: 8px;
            border-style: solid;
            border-color: transparent transparent transparent white;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        .talk-animation {
            animation: talk 0.5s infinite alternate;
        }
        
        .happy-animation {
            animation: happy 1s ease;
        }
        
        .sad-animation {
            animation: sad 1s ease;
        }
        
        .nod-animation {
            animation: nod 0.5s ease;
        }
        
        @keyframes talk {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-3px) scale(1.05); }
            100% { transform: translateY(0) scale(1); }
        }
        
        @keyframes happy {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(10deg); }
            50% { transform: rotate(-10deg); }
            75% { transform: rotate(5deg); }
        }
        
        @keyframes sad {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(5px); }
        }
        
        @keyframes nod {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* æ–°å¢å‘¼å¸å¼•å¯¼åŠ¨ç”» */
        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        
        .breathe-animation {
            animation: breathe 4s infinite ease-in-out;
        }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white/90 backdrop-blur-md p-4 border-b border-gray-200/50 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-3">
            <button id="sidebar-toggle" class="w-9 h-9 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100">
                <i class="fas fa-bars"></i>
            </button>
            <a href="å¢¨è¯­æ™ºå­¦é¦–é¡µ.html" class="flex items-center gap-2">
                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center text-white">
                    <i class="fas fa-robot"></i>
                </div>
                <h1 class="text-xl font-semibold text-gray-800 hover:text-primary transition-colors">å¢¨è¯­æ™ºå­¦ AI</h1>
            </a>
        </div>
        <div class="flex items-center gap-4">
            <a href="å¢¨è¯­æ™ºå­¦é¦–é¡µ.html" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 flex items-center gap-2">
                <i class="fas fa-home"></i>
                <span>è¿”å›é¦–é¡µ</span>
            </a>
            <button id="new-chat-btn" class="px-4 py-2 bg-gradient-to-r from-primary to-secondary text-white rounded-lg hover:opacity-90 flex items-center gap-2">
                <i class="fas fa-plus"></i>
                <span>æ–°å¯¹è¯</span>
            </button>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="flex flex-1 overflow-hidden">
        <!-- ä¾§è¾¹æ  -->
        <div id="sidebar" class="sidebar w-64 bg-white/90 backdrop-blur-md border-r border-gray-200/50 flex flex-col absolute lg:relative z-20 h-full shadow-lg">
            <div class="p-4 border-b border-gray-200">
                <button id="sidebar-new-chat-btn" class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 px-4 rounded-lg flex items-center justify-center gap-2 hover:opacity-90">
                    <i class="fas fa-plus"></i>
                    <span class="whitespace-nowrap">æ–°å»ºå¯¹è¯</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto scrollbar-custom">
                <div class="p-4">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-sm font-medium text-gray-700">å¯¹è¯åˆ†ç±»</span>
                        <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                    </div>
                    <div class="space-y-2">
                        <button id="learning-assistant-btn" class="w-full text-left px-3 py-2 rounded-lg bg-blue-50 text-primary flex items-center gap-2">
                            <i class="fas fa-graduation-cap"></i>
                            <span>å­¦ä¹ åŠ©æ‰‹</span>
                        </button>
                        <button id="translation-assistant-btn" class="w-full text-left px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                            <i class="fas fa-language"></i>
                            <span>ç¿»è¯‘åŠ©æ‰‹</span>
                        </button>
                        <button id="writing-assistant-btn" class="w-full text-left px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                            <i class="fas fa-pen"></i>
                            <span>å†™ä½œåŠ©æ‰‹</span>
                        </button>
                    </div>
                    
                    <!-- å¿«é€Ÿæ“ä½œæŒ‰é’®ç§»åŠ¨åˆ°ä¾§è¾¹æ  -->
                    <div class="mt-4 space-y-2">
                        <button class="w-full text-left px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center gap-2 quick-action-btn">
                            <i class="fas fa-microphone-alt"></i>
                            <span>å£è¯­ç»ƒä¹ </span>
                        </button>
                        <button class="w-full text-left px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center gap-2 quick-action-btn">
                            <i class="fas fa-spell-check"></i>
                            <span>è¯­æ³•æ£€æŸ¥</span>
                        </button>
                        <button class="w-full text-left px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center gap-2 quick-action-btn">
                            <i class="fas fa-language"></i>
                            <span>æ–‡æœ¬ç¿»è¯‘</span>
                        </button>
                        <button class="w-full text-left px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center gap-2 quick-action-btn">
                            <i class="fas fa-book"></i>
                            <span>å­¦ä¹ è®¡åˆ’</span>
                        </button>
                    </div>
                    
                   <!-- æ–°å¢å¤ä¹ æé†’åŒºåŸŸ -->
                    <div class="mt-6 p-3 bg-blue-50/50 rounded-lg">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-history text-primary"></i>
                            <span class="text-sm font-medium text-primary">å¤ä¹ æé†’</span>
                        </div>
                        <div id="review-reminder-list" class="text-sm text-gray-700">
                            <p class="text-xs">åŠ è½½å¤ä¹ è®¡åˆ’ä¸­...</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm font-medium text-gray-700">å†å²å¯¹è¯</span>
                        <button class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                    </div>
                    <div class="space-y-3" id="chat-history-list">
                        <div class="p-3 rounded-lg bg-gray-50/80 hover:bg-gray-100/90 cursor-pointer backdrop-blur-sm border border-gray-100/20">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium text-gray-900">è‹±è¯­å£è¯­ç»ƒä¹ </span>
                                <span class="text-xs text-gray-500">2å°æ—¶å‰</span>
                            </div>
                            <p class="text-xs text-gray-500 truncate">è®©æˆ‘ä»¬æ¥ç»ƒä¹ æ—¥å¸¸è‹±è¯­å¯¹è¯...</p>
                        </div>
                        <div class="p-3 rounded-lg bg-gray-50/80 hover:bg-gray-100/90 cursor-pointer backdrop-blur-sm border border-gray-100/20">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium text-gray-900">æ–‡ç« æ¶¦è‰²</span>
                                <span class="text-xs text-gray-500">æ˜¨å¤©</span>
                            </div>
                            <p class="text-xs text-gray-500 truncate">è¿™ç¯‡æ–‡ç« éœ€è¦è¿›è¡Œè¯­æ³•æ£€æŸ¥å’Œä¼˜åŒ–...</p>
                        </div>
                        <div class="p-3 rounded-lg bg-gray-50/80 hover:bg-gray-100/90 cursor-pointer backdrop-blur-sm border border-gray-100/20">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium text-gray-900">è¯æ±‡å­¦ä¹ </span>
                                <span class="text-xs text-gray-500">2å¤©å‰</span>
                            </div>
                            <p class="text-xs text-gray-500 truncate">ä»Šå¤©æˆ‘ä»¬æ¥å­¦ä¹ å•†åŠ¡è‹±è¯­è¯æ±‡...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <img src="https://imgur.la/images/2025/06/07/94B2FFC12D41C799B69B2668BBA16BE7.jpg" class="w-8 h-8 rounded-full" alt="ç”¨æˆ·å¤´åƒ">
                        <div>
                            <div class="text-sm font-medium text-gray-900">ç‹æ¢¦çª</div>
                            <div class="text-xs text-gray-500">é«˜çº§ä¼šå‘˜</div>
                        </div>
                    </div>
                    <button class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ä¾§è¾¹æ é®ç½© -->
        <div id="sidebar-overlay" class="sidebar-overlay fixed inset-0 bg-black/50 z-10 lg:hidden"></div>

        <!-- èŠå¤©ä¸»åŒºåŸŸ -->
        <div class="flex-1 flex flex-col">
            <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
            <div id="chat-content-container" class="chat-content-container scrollbar-custom">
                <div id="chat-content" class="chat-content space-y-6">
                    <!-- æ¬¢è¿æ¶ˆæ¯ -->
                    <div id="welcome-container" class="welcome-container">
                        <div class="message-ai p-6 shadow-message">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯å¢¨è¯­æ™ºå­¦ AIï¼Œä½ çš„æ™ºèƒ½å­¦ä¹ ä¼™ä¼´</h2>
                            <p class="font-content text-gray-700 mb-4">æˆ‘å¯ä»¥å¸®åŠ©ä½ è§£å†³è‹±è¯­å­¦ä¹ ä¸­çš„å„ç§é—®é¢˜ï¼ŒåŒ…æ‹¬å¬åŠ›ã€é˜…è¯»ã€å†™ä½œå’Œç¿»è¯‘ç­‰æ–¹é¢ã€‚è®©æˆ‘ä»¬ä¸€èµ·è½»æ¾æ„‰å¿«åœ°å­¦ä¹ å§ï¼</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-blue-50/50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-primary mb-2">ğŸ“š å­¦ä¹ è¾…å¯¼</h3>
                                    <ul class="font-content text-gray-700 space-y-1">
                                        <li>â€¢ è§£ç­”è‹±è¯­å­¦ä¹ é—®é¢˜</li>
                                        <li>â€¢ æä¾›å››å…­çº§/é›…æ€å¤‡è€ƒå»ºè®®</li>
                                        <li>â€¢ æ£€æŸ¥è¯­æ³•å’Œå†™ä½œ</li>
                                        <li>â€¢ è§£æå¤æ‚å¥å­ç»“æ„</li>
                                    </ul>
                                </div>
                                <div class="bg-blue-50/50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-primary mb-2">âœ¨ å®ç”¨åŠŸèƒ½</h3>
                                    <ul class="font-content text-gray-700 space-y-1">
                                        <li>â€¢ ä¸“ä¸šä¸­è‹±æ–‡ç¿»è¯‘</li>
                                        <li>â€¢ æ¨¡æ‹Ÿå£è¯­å¯¹è¯ç»ƒä¹ </li>
                                        <li>â€¢ ç”Ÿæˆä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’</li>
                                        <li>â€¢ æä¾›å­¦ä¹ èµ„æºæ¨è</li>
                                    </ul>
                                </div>
                            </div>
                    
                    <!-- è¿™é‡Œä¼šåŠ¨æ€æ·»åŠ èŠå¤©æ¶ˆæ¯ -->
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div id="input-container" class="input-container">
                <div class="input-wrapper">
                    <!-- è¾“å…¥æ¡† -->
                    <div class="flex gap-2">
                        <div class="flex-1 relative">
                            <textarea 
                                id="user-input"
                                class="input-box w-full p-3 pr-10 rounded-lg border border-gray-200 bg-white/80 backdrop-blur-sm focus:outline-none resize-none font-content"
                                rows="1"
                                placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰ Shift+Enter æ¢è¡Œ"
                            ></textarea>
                            <!-- æ–°å¢æƒ…æ„ŸçŠ¶æ€æŒ‡ç¤ºå™¨ -->
                            <div id="emotion-indicator" class="emotion-indicator hidden"></div>
                        </div>
                        <button 
                            id="send-btn"
                            class="send-btn bg-gradient-to-r from-primary to-secondary text-white w-12 h-12 rounded-lg flex items-center justify-center shadow"
                            disabled
                        >
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <!-- å¿«æ·å·¥å…·æ  -->
                    <div class="flex items-center justify-center gap-3 mt-3">
                        <button id="voice-btn" class="tooltip-parent w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100">
                            <i class="fas fa-microphone"></i>
                            <span class="tooltip absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap">è¯­éŸ³è¾“å…¥</span>
                        </button>
                        <button id="image-btn" class="tooltip-parent w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100">
                            <i class="fas fa-camera"></i>
                            <span class="tooltip absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap">å›¾ç‰‡è¯†åˆ«</span>
                        </button>
                        <button id="file-btn" class="tooltip-parent w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100">
                            <i class="fas fa-file-upload"></i>
                            <span class="tooltip absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap">æ–‡ä»¶ä¸Šä¼ </span>
                        </button>
                        <div class="h-5 w-px bg-gray-200 mx-1"></div>
                        <button id="keyboard-btn" class="tooltip-parent w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100">
                            <i class="fas fa-keyboard"></i>
                            <span class="tooltip absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap">é”®ç›˜è¾“å…¥</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div id="file-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">ä¸Šä¼ æ–‡ä»¶</h3>
                <button id="close-file-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center mb-4">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-600 mb-2">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </p>
                <input type="file" id="file-upload" class="hidden" multiple>
                <button id="select-file-btn" class="bg-primary text-white px-4 py-2 rounded-lg hover:opacity-90">
                    é€‰æ‹©æ–‡ä»¶
                </button>
            </div>
            <div id="file-preview" class="hidden">
                <h4 class="text-sm font-medium mb-2">å·²é€‰æ‹©æ–‡ä»¶ï¼š</h4>
                <div id="file-list" class="text-sm text-gray-600 mb-4"></div>
                <button id="confirm-upload" class="w-full bg-primary text-white py-2 rounded-lg hover:opacity-90">
                    ä¸Šä¼ å¹¶å‘é€
                </button>
            </div>
        </div>
    </div>
    
    <!-- å‘¼å¸å¼•å¯¼æ¨¡æ€æ¡† -->
    <div id="breathe-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center">
            <div class="mb-4">
                <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mx-auto breathe-animation">
                    <i class="fas fa-wind text-3xl text-primary"></i>
                </div>
            </div>
            <h3 class="text-xl font-medium mb-2">æ·±å‘¼å¸æ”¾æ¾ä¸€ä¸‹</h3>
            <p class="text-gray-600 mb-4">è·ŸéšåŠ¨ç”»èŠ‚å¥æ·±å‘¼å¸ï¼Œå¸æ°”... å‘¼æ°”...</p>
            <button id="close-breathe-modal" class="bg-primary text-white px-6 py-2 rounded-lg hover:opacity-90">
                æˆ‘æ„Ÿè§‰å¥½å¤šäº†
            </button>
        </div>
    </div>

    <!-- æœºæ¢°äººåŠ©æ‰‹å®¹å™¨ - ä¿®æ”¹ä¸ºä¸è®¡åˆ’ç•Œé¢ä¸€è‡´çš„æ ·å¼ -->
    <div id="robot-assistant-container">
        <div class="robot-image-container">
            <img src="https://imgur.la/images/2025/06/08/AB9D66DF1072932D11D8D306BE46693C.jpg" alt="å°åŠ©æ‰‹" class="robot-image">
        </div>
        <div class="robot-message"></div>
    </div>

    <script>
        // é…ç½®æ™ºæ™®API
        const ZHIPU_API_KEY = "fb70a667fee0422ca79519e4fe598cff.JO3wADNEk2VeaPYQ";
        const ZHIPU_API_URL = "https://open.bigmodel.cn/api/paas/v4/chat/completions";
        
        // DOMå…ƒç´ 
        const chatContainer = document.getElementById('chat-content');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const newChatBtn = document.getElementById('new-chat-btn');
        const sidebarNewChatBtn = document.getElementById('sidebar-new-chat-btn');
        const inputContainer = document.getElementById('input-container');
        const welcomeContainer = document.getElementById('welcome-container');
        const voiceBtn = document.getElementById('voice-btn');
        const fileBtn = document.getElementById('file-btn');
        const fileModal = document.getElementById('file-modal');
        const closeFileModal = document.getElementById('close-file-modal');
        const fileUpload = document.getElementById('file-upload');
        const selectFileBtn = document.getElementById('select-file-btn');
        const filePreview = document.getElementById('file-preview');
        const fileList = document.getElementById('file-list');
        const confirmUpload = document.getElementById('confirm-upload');
        const chatHistoryList = document.getElementById('chat-history-list');
        const chatContentContainer = document.getElementById('chat-content-container');
        const emotionIndicator = document.getElementById('emotion-indicator');
        const breatheModal = document.getElementById('breathe-modal');
        const closeBreatheModal = document.getElementById('close-breathe-modal');
        const reviewReminderList = document.getElementById('review-reminder-list');
        
        // åŠ©æ‰‹ç›¸å…³å…ƒç´ 
        const learningAssistantBtn = document.getElementById('learning-assistant-btn');
        const translationAssistantBtn = document.getElementById('translation-assistant-btn');
        const writingAssistantBtn = document.getElementById('writing-assistant-btn');
        
        // å½“å‰å¯¹è¯ID
        let currentChatId = generateChatId();
        // æ˜¯å¦æ­£åœ¨ç­‰å¾…AIå“åº”
        let isWaitingForResponse = false;
        // è¯­éŸ³è¯†åˆ«API
        let recognition = null;
        // å½“å‰é€‰æ‹©çš„åŠ©æ‰‹ç±»å‹
        let currentAssistant = 'learning';
        // å¯¹è¯å†å²
        let conversationHistory = [
            {
                role: "system",
                content: getSystemPrompt('learning')
            }
        ];
        // æœºæ¢°äººåŠ©æ‰‹å®ä¾‹
        let robotAssistant = null;
        // ç”¨æˆ·æƒ…ç»ªçŠ¶æ€
        let userEmotion = null;
        // æ‰“å­—é€Ÿåº¦ç›‘æµ‹
        let typingSpeed = 0;
        let lastTypingTime = 0;
        let typingInterval = null;
        
        // åŠ©æ‰‹ç³»ç»Ÿæç¤ºè¯
        function getSystemPrompt(assistantType) {
            const prompts = {
                'learning': `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šä¸”å‹å¥½çš„ä¸­è‹±æ–‡å­¦ä¹ åŠ©æ‰‹ï¼Œåå«å¢¨è¯­æ™ºå­¦AIã€‚ä½ çš„ä»»åŠ¡æ˜¯å¸®åŠ©ç”¨æˆ·è§£å†³è‹±è¯­å­¦ä¹ ä¸­çš„å„ç§é—®é¢˜ï¼ŒåŒ…æ‹¬å¬åŠ›ã€é˜…è¯»ã€å†™ä½œå’Œç¿»è¯‘ç­‰æ–¹é¢ã€‚å›ç­”è¦ä¸“ä¸šã€å‡†ç¡®ä¸”å‹å¥½ï¼Œä½¿ç”¨ç°ä»£å¹´è½»äººå–œæ¬¢çš„è½»æ¾è¯­è¨€é£æ ¼ã€‚è¯·éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š
1. ä½¿ç”¨ç®€æ´æ˜äº†çš„è¯­è¨€ï¼Œé¿å…å¤æ‚æœ¯è¯­ï¼Œå¿…è¦æ—¶ç”¨ç®€å•ä¾‹å­è§£é‡Š
2. é€‚å½“ä½¿ç”¨emojiè¡¨æƒ…å¢åŠ äº²å’ŒåŠ›
3. å¯¹ä¸“ä¸šé—®é¢˜æä¾›è¯¦ç»†è§£æï¼ŒåŒ…æ‹¬è¯­æ³•ç»“æ„ã€è¯æ±‡ç”¨æ³•ç­‰
4. å¯¹å¤æ‚æ¦‚å¿µåˆ†æ­¥éª¤è§£é‡Š
5. æä¾›å®ç”¨å­¦ä¹ æŠ€å·§å’Œè®°å¿†æ–¹æ³•
6. ä¿æŒç§¯æé¼“åŠ±çš„æ€åº¦
7. æ ¹æ®ç”¨æˆ·æƒ…ç»ªçŠ¶æ€è°ƒæ•´å›å¤è¯­æ°”
8. æ¨èå¤šæ¨¡æ€å­¦ä¹ æ–¹æ³•ï¼ˆå¬ã€è¯´ã€è¯»ã€å†™ç»“åˆï¼‰
9. å®šæœŸæé†’å¤ä¹ é‡è¦çŸ¥è¯†ç‚¹`,
                'translation': `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¸­è‹±æ–‡ç¿»è¯‘åŠ©æ‰‹ï¼Œåå«å¢¨è¯­æ™ºå­¦AIã€‚ä½ çš„ä»»åŠ¡æ˜¯æä¾›å‡†ç¡®ã€æµç•…çš„ä¸­è‹±äº’è¯‘æœåŠ¡ã€‚è¯·éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š
1. ä¿æŒåŸæ–‡æ„æ€å‡†ç¡®ä¼ è¾¾
2. è¯‘æ–‡è¦ç¬¦åˆç›®æ ‡è¯­è¨€çš„è¡¨è¾¾ä¹ æƒ¯
3. å¯¹ä¸“ä¸šæœ¯è¯­æä¾›è§£é‡Š
4. å¯¹æ–‡åŒ–å·®å¼‚éƒ¨åˆ†æä¾›æ³¨é‡Š
5. æä¾›å¤šç§å¯èƒ½çš„ç¿»è¯‘ç‰ˆæœ¬ä¾›é€‰æ‹©
6. ä¿æŒç¿»è¯‘çš„è‡ªç„¶æµç•…`,
                'writing': `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è‹±æ–‡å†™ä½œåŠ©æ‰‹ï¼Œåå«å¢¨è¯­æ™ºå­¦AIã€‚ä½ çš„ä»»åŠ¡æ˜¯å¸®åŠ©ç”¨æˆ·æå‡è‹±æ–‡å†™ä½œæ°´å¹³ã€‚è¯·éµå¾ªä»¥ä¸‹è§„åˆ™:
1. å¯¹ç”¨æˆ·æä¾›çš„æ–‡æœ¬è¿›è¡Œæ¶¦è‰²ï¼Œæå‡è¡¨è¾¾è´¨é‡
2. è§£é‡Šä¿®æ”¹çš„åŸå› å’Œå¥½å¤„
3. æä¾›å¤šç§è¡¨è¾¾æ–¹å¼ä¾›é€‰æ‹©
4. æŒ‡å‡ºå¸¸è§çš„å†™ä½œé”™è¯¯
5. æ ¹æ®éœ€æ±‚è°ƒæ•´å†™ä½œé£æ ¼
6. ä¿æŒåé¦ˆå»ºè®¾æ€§å’Œé¼“åŠ±æ€§`
            };
            
            return prompts[assistantType] || prompts['learning'];
        }
        
        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            setupEventListeners();
            loadChatHistory();
            adjustInputPosition();
            loadReviewReminders();
            
            // åˆå§‹åŒ–å¢å¼ºç‰ˆæœºæ¢°äººåŠ©æ‰‹
            robotAssistant = new EnhancedRobotAssistant('robot-assistant-container');
            
            // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            setTimeout(() => {
                robotAssistant.showRandomMessage(3000);
            }, 2000);
            
            // å¯åŠ¨æ‰“å­—é€Ÿåº¦ç›‘æµ‹
            startTypingSpeedMonitor();
        }
        
        // åŠ è½½å¤ä¹ æé†’
        function loadReviewReminders() {
            const learningRecords = JSON.parse(localStorage.getItem('learningRecords') || '[]');
            const now = new Date();
            
            const toReview = learningRecords.filter(record => {
                const lastReview = new Date(record.lastReview);
                const hoursPassed = (now - lastReview) / (1000 * 60 * 60);
                
                // è‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿å…³é”®æ—¶é—´ç‚¹ï¼š20åˆ†é’Ÿ, 1å°æ—¶, 9å°æ—¶, 1å¤©, 2å¤©, 6å¤©, 31å¤©
                const reviewIntervals = [0.33, 1, 9, 24, 48, 144, 744];
                const nextReviewIndex = Math.min(record.reviewCount, reviewIntervals.length - 1);
                return hoursPassed >= reviewIntervals[nextReviewIndex];
            });
            
            if (toReview.length === 0) {
                reviewReminderList.innerHTML = '<p class="text-xs">æš‚æ— å¾…å¤ä¹ å†…å®¹</p>';
                return;
            }
            
            let html = '<ul class="space-y-1">';
            toReview.slice(0, 3).forEach(record => {
                const masteryPercent = Math.round(record.mastery * 100);
                html += `
                    <li class="flex items-center justify-between">
                        <span class="truncate">${record.topic}</span>
                        <span class="text-xs text-gray-500">${masteryPercent}%</span>
                    </li>
                `;
            });
            html += '</ul>';
            
            if (toReview.length > 3) {
                html += `<p class="text-xs text-gray-500 mt-1">+${toReview.length - 3}æ›´å¤š...</p>`;
            }
            
            reviewReminderList.innerHTML = html;
        }
        
        // å¼€å§‹æ‰“å­—é€Ÿåº¦ç›‘æµ‹
        function startTypingSpeedMonitor() {
            userInput.addEventListener('keydown', () => {
                const now = Date.now();
                if (lastTypingTime > 0) {
                    typingSpeed = 1000 / (now - lastTypingTime); // å­—ç¬¦/ç§’
                    
                    // æ£€æµ‹ç„¦è™‘æƒ…ç»ªï¼ˆæ‰“å­—é€Ÿåº¦è¿‡å¿«ï¼‰
                    if (typingSpeed > 5) { // è¶…è¿‡5å­—ç¬¦/ç§’è®¤ä¸ºæ˜¯ç„¦è™‘
                        detectEmotion('anxious');
                    }
                }
                lastTypingTime = now;
                
                // é‡ç½®è®¡æ—¶å™¨
                clearTimeout(typingInterval);
                typingInterval = setTimeout(() => {
                    typingSpeed = 0;
                }, 1000);
            });
        }
        
        // æ£€æµ‹ç”¨æˆ·æƒ…ç»ª
        function detectEmotion(emotion) {
            if (userEmotion === emotion) return;
            
            userEmotion = emotion;
            
            // æ›´æ–°æƒ…ç»ªæŒ‡ç¤ºå™¨
            emotionIndicator.className = 'emotion-indicator';
            emotionIndicator.classList.add(`emotion-${emotion}`);
            emotionIndicator.classList.remove('hidden');
            
            // æ ¹æ®æƒ…ç»ªçŠ¶æ€è°ƒæ•´äº¤äº’
            switch(emotion) {
                case 'anxious':
                    // æ˜¾ç¤ºå‘¼å¸å¼•å¯¼
                    showBreatheModal();
                    break;
                case 'frustrated':
                    // æä¾›é¼“åŠ±
                    if (robotAssistant) {
                        robotAssistant.showMessage(robotAssistant.config.learningPrompts.emotionSupport.frustrated, 3000);
                    }
                    break;
            }
            
            // 3ç§’åéšè—æƒ…ç»ªæŒ‡ç¤ºå™¨
            setTimeout(() => {
                emotionIndicator.classList.add('hidden');
            }, 3000);
        }
        
        // æ˜¾ç¤ºå‘¼å¸å¼•å¯¼æ¨¡æ€æ¡†
        function showBreatheModal() {
            breatheModal.classList.remove('hidden');
            
            // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
            if (robotAssistant) {
                robotAssistant.showMessage('æ£€æµ‹åˆ°ä½ æœ‰äº›ç´§å¼ ï¼Œæ·±å‘¼å¸æ”¾æ¾ä¸€ä¸‹', 3000);
            }
        }
        
        // éšè—å‘¼å¸å¼•å¯¼æ¨¡æ€æ¡†
        function hideBreatheModal() {
            breatheModal.classList.add('hidden');
            userEmotion = null;
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ä¾§è¾¹æ åˆ‡æ¢
            sidebarToggle.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            
            // æ–°å¯¹è¯æŒ‰é’®
            newChatBtn.addEventListener('click', createNewChat);
            sidebarNewChatBtn.addEventListener('click', createNewChat);
            
            // è¾“å…¥æ¡†äº‹ä»¶
            userInput.addEventListener('input', handleInputChange);
            userInput.addEventListener('keydown', handleKeyDown);
            sendBtn.addEventListener('click', sendMessage);
            
            // å¿«æ·æ“ä½œæŒ‰é’®
            document.querySelectorAll('.quick-action-btn').forEach(btn => {
                btn.addEventListener('click', handleQuickAction);
            });
            
            // æ–‡ä»¶ä¸Šä¼ 
            fileBtn.addEventListener('click', showFileModal);
            closeFileModal.addEventListener('click', hideFileModal);
            selectFileBtn.addEventListener('click', () => fileUpload.click());
            fileUpload.addEventListener('change', handleFileSelect);
            confirmUpload.addEventListener('click', handleFileUpload);
            
            // å‘¼å¸å¼•å¯¼
            closeBreatheModal.addEventListener('click', hideBreatheModal);
            
            // è¯­éŸ³è¾“å…¥
            voiceBtn.addEventListener('click', toggleVoiceInput);
            
            // çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', adjustInputPosition);
            
            // ç‚¹å‡»èŠå¤©å†å²
            document.querySelectorAll('#chat-history-list > div').forEach(item => {
                item.addEventListener('click', loadChatFromHistory);
            });
            
            // åŠ©æ‰‹æŒ‰é’®ç‚¹å‡»
            learningAssistantBtn.addEventListener('click', () => switchAssistant('learning'));
            translationAssistantBtn.addEventListener('click', () => switchAssistant('translation'));
            writingAssistantBtn.addEventListener('click', () => switchAssistant('writing'));
        }
        
        // åˆ‡æ¢åŠ©æ‰‹ç±»å‹
        function switchAssistant(type) {
            currentAssistant = type;
            
            // æ›´æ–°æŒ‰é’®é€‰ä¸­çŠ¶æ€
            [learningAssistantBtn, translationAssistantBtn, writingAssistantBtn].forEach(btn => {
                btn.classList.remove('bg-blue-50', 'text-primary');
            });
            
            if (type === 'learning') {
                learningAssistantBtn.classList.add('bg-blue-50', 'text-primary');
            } else if (type === 'translation') {
                translationAssistantBtn.classList.add('bg-blue-50', 'text-primary');
            } else if (type === 'writing') {
                writingAssistantBtn.classList.add('bg-blue-50', 'text-primary');
            }
            
            // æ›´æ–°ç³»ç»Ÿæç¤º
            conversationHistory[0] = {
                role: "system",
                content: getSystemPrompt(type)
            };
            
            // æ˜¾ç¤ºåˆ‡æ¢æç¤º
            const assistantNames = {
                'learning': 'å­¦ä¹ åŠ©æ‰‹',
                'translation': 'ç¿»è¯‘åŠ©æ‰‹',
                'writing': 'å†™ä½œåŠ©æ‰‹'
            };
            
            addMessage(`å·²åˆ‡æ¢åˆ°${assistantNames[type]}æ¨¡å¼ï¼Œæˆ‘å¯ä»¥ä¸ºä½ æä¾›ç›¸å…³å¸®åŠ©å•¦ï¼`, 'ai');
            
            // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
            if (robotAssistant) {
                robotAssistant.showMessage(`å·²åˆ‡æ¢åˆ°${assistantNames[type]}æ¨¡å¼`);
            }
        }
        
        // ç”Ÿæˆå”¯ä¸€å¯¹è¯ID
        function generateChatId() {
            return 'chat-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        // ä¾§è¾¹æ åˆ‡æ¢
        function toggleSidebar() {
            sidebar.classList.toggle('sidebar-open');
            sidebarOverlay.classList.toggle('sidebar-overlay-open');
            adjustInputPosition();
        }
        
        // è°ƒæ•´è¾“å…¥æ¡†ä½ç½®
        function adjustInputPosition() {
            if (window.innerWidth >= 1024 && sidebar.classList.contains('sidebar-open')) {
                chatContentContainer.style.left = '256px';
                inputContainer.style.left = '256px';
            } else {
                chatContentContainer.style.left = '0';
                inputContainer.style.left = '0';
            }
        }
        
        // å¤„ç†è¾“å…¥æ¡†å˜åŒ–
        function handleInputChange() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            sendBtn.disabled = this.value.trim() === '';
        }
        
        // å¤„ç†é”®ç›˜äº‹ä»¶
        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || isWaitingForResponse) return;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            userInput.value = '';
            userInput.style.height = '48px';
            sendBtn.disabled = true;
            
            // æ›´æ–°å¯¹è¯å†å²
            conversationHistory.push({
                role: "user",
                content: message
            });
            
            // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
            if (robotAssistant) {
                robotAssistant.respondToMessage(message, 'user', userEmotion);
            }
            
            // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
            const typingIndicator = showTypingIndicator();
            isWaitingForResponse = true;
            
            try {
                // è°ƒç”¨æ™ºæ™®API
                const aiResponse = await callZhipuAPI();
                
                // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨å¹¶æ·»åŠ AIå›å¤
                removeTypingIndicator(typingIndicator);
                addMessage(aiResponse, 'ai');
                
                // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
                if (robotAssistant) {
                    robotAssistant.respondToMessage(aiResponse, 'ai');
                }
                
                // æ›´æ–°å¯¹è¯å†å²
                conversationHistory.push({
                    role: "assistant",
                    content: aiResponse
                });
                
                // ä¿å­˜å¯¹è¯åˆ°å†å²è®°å½•
                saveChatToHistory(message, aiResponse);
                
                // é‡ç½®æƒ…ç»ªçŠ¶æ€
                userEmotion = null;
            } catch (error) {
                removeTypingIndicator(typingIndicator);
                addMessage("ğŸ˜… æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å¤„ç†æ‚¨çš„è¯·æ±‚ã€‚è¯·ç¨åå†è¯•ã€‚", 'ai');
                console.error("APIè°ƒç”¨é”™è¯¯:", error);
                
                // æ£€æµ‹æ²®ä¸§æƒ…ç»ª
                detectEmotion('frustrated');
            } finally {
                isWaitingForResponse = false;
            }
        }
        
        // è°ƒç”¨æ™ºæ™®API
        async function callZhipuAPI() {
            const requestData = {
                model: "glm-4",
                messages: conversationHistory,
                temperature: 0.7,
                max_tokens: 2000
            };
            
            const response = await fetch(ZHIPU_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ZHIPU_API_KEY}`,
                    'Accept': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex gap-3 ${sender === 'user' ? 'justify-end' : ''} message`;
            
            // æ ¼å¼åŒ–AIå›å¤
            const formattedText = sender === 'ai' ? formatAIResponse(text) : formatMessageText(text);
            
            messageDiv.innerHTML = `
                ${sender === 'ai' ? `
                    <div class="flex-shrink-0">
                        <img src="https://imgur.la/images/2025/06/07/EC7EBB3B90A4F05570C65C83DAAAC21A.jpg" class="w-10 h-10 rounded-full" alt="AIå¤´åƒ">
                    </div>
                ` : ''}
                
                <div class="flex-1 ${sender === 'user' ? 'flex justify-end' : ''}">
                    <div class="${sender === 'user' ? 'message-user' : 'message-ai'} p-4 shadow-message">
                        ${sender === 'user' && userEmotion ? `<div class="emotion-indicator emotion-${userEmotion}"></div>` : ''}
                        <div class="${sender === 'ai' ? 'ai-response' : ''}">
                            ${formattedText}
                        </div>
                    </div>
                </div>
                
                ${sender === 'user' ? `
                    <div class="flex-shrink-0">
                        <img src="https://imgur.la/images/2025/06/07/94B2FFC12D41C799B69B2668BBA16BE7.jpg" class="w-10 h-10 rounded-full" alt="ç”¨æˆ·å¤´åƒ">
                    </div>
                ` : ''}
            `;
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // æ ¼å¼åŒ–AIå›å¤
        function formatAIResponse(text) {
            // 1. å¤„ç†Markdowné£æ ¼çš„æ ‡é¢˜
            text = text.replace(/^#\s(.+)$/gm, '<h2>$1</h2>')
                       .replace(/^##\s(.+)$/gm, '<h3>$1</h3>')
                       .replace(/^###\s(.+)$/gm, '<h4>$1</h4>');
            
            // 2. å¤„ç†åˆ—è¡¨é¡¹
            text = text.replace(/^\*\s(.+)$/gm, '<li>$1</li>')
                       .replace(/^-\s(.+)$/gm, '<li>$1</li>')
                       .replace(/^\d\.\s(.+)$/gm, '<li>$1</li>');
            
            // 3. å¤„ç†ä»£ç å—
            text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            
            // 4. å¤„ç†å†…è”ä»£ç 
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // 5. å¤„ç†å¼•ç”¨
            text = text.replace(/^>\s(.+)$/gm, '<blockquote>$1</blockquote>');
            
            // 6. å¤„ç†æç¤ºæ¡†
            text = text.replace(/\[tip\]([\s\S]*?)\[\/tip\]/g, '<div class="tip-box">$1</div>');
            text = text.replace(/\[example\]([\s\S]*?)\[\/example\]/g, '<div class="example-box">$1</div>');
            text = text.replace(/\[warning\]([\s\S]*?)\[\/warning\]/g, '<div class="warning-box">$1</div>');
            
            // 7. å¤„ç†å¤ä¹ æé†’
            text = text.replace(/\[review\]([\s\S]*?)\[\/review\]/g, '<div class="review-reminder"><h4>ğŸ“Œ å¤ä¹ æé†’</h4>$1</div>');
            
            // 8. å¤„ç†é«˜äº®æ–‡æœ¬
            text = text.replace(/\*\*(.+?)\*\*/g, '<span class="highlight">$1</span>');
            
            // 9. å¤„ç†æ¢è¡Œ
            text = text.replace(/\n/g, '<br>');
            
            // 10. è‡ªåŠ¨æ£€æµ‹URLå¹¶æ·»åŠ é“¾æ¥
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
            
            // 11. æ·»åŠ emojiè¡¨æƒ…
            const emojiMap = {
                ':smile:': 'ğŸ˜Š',
                ':laugh:': 'ğŸ˜‚',
                ':wink:': 'ğŸ˜‰',
                ':cool:': 'ğŸ˜',
                ':thumbsup:': 'ğŸ‘',
                ':lightbulb:': 'ğŸ’¡',
                ':book:': 'ğŸ“š',
                ':pencil:': 'âœï¸',
                ':star:': 'â­',
                ':check:': 'âœ…'
            };
            
            for (const [key, emoji] of Object.entries(emojiMap)) {
                text = text.replace(new RegExp(key, 'g'), `<span class="emoji">${emoji}</span>`);
            }
            
            return text;
        }
        
        // æ ¼å¼åŒ–æ™®é€šæ¶ˆæ¯æ–‡æœ¬
        function formatMessageText(text) {
            // å¤„ç†æ¢è¡Œ
            let formattedText = text.replace(/\n/g, '<br>');
            
            // å¤„ç†å¼•ç”¨ (ä»¥"> "å¼€å¤´çš„è¡Œ)
            formattedText = formattedText.replace(/(&gt;|>)\s*(.*?)(<br>|$)/g, '<div class="citation">$2</div>');
            
            return formattedText;
        }
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            chatContentContainer.scrollTo({
                top: chatContentContainer.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        // æ˜¾ç¤º"æ­£åœ¨è¾“å…¥"æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'flex gap-3 message';
            indicatorDiv.id = 'typing-indicator';
            
            indicatorDiv.innerHTML = `
                <div class="flex-shrink-0">
                    <img src="https://imgur.la/images/2025/05/25/8FD2FAC7A22B1A46F97B48F3FB37223F.jpg" class="w-10 h-10 rounded-full" alt="AIå¤´åƒ">
                </div>
                <div class="message-ai p-4 shadow-message">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(indicatorDiv);
            scrollToBottom();
            
            return indicatorDiv;
        }
        
        // ç§»é™¤"æ­£åœ¨è¾“å…¥"æŒ‡ç¤ºå™¨
        function removeTypingIndicator(indicator) {
            if (indicator && indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
            }
        }
        
        // åˆ›å»ºæ–°å¯¹è¯
        function createNewChat() {
            if (isWaitingForResponse) {
                alert('è¯·ç­‰å¾…å½“å‰å¯¹è¯å®Œæˆåå†å¼€å§‹æ–°å¯¹è¯');
                return;
            }
            
            if (confirm('ç¡®å®šè¦å¼€å§‹æ–°çš„å¯¹è¯å—ï¼Ÿå½“å‰å¯¹è¯å°†ä¿å­˜åˆ°å†å²è®°å½•ä¸­ã€‚')) {
                // ç”Ÿæˆæ–°å¯¹è¯ID
                currentChatId = generateChatId();
                
                // é‡ç½®å¯¹è¯å†å²
                conversationHistory = [
                    {
                        role: "system",
                        content: getSystemPrompt(currentAssistant)
                    }
                ];
                
                // æ¸…é™¤èŠå¤©å†…å®¹ï¼Œä¿ç•™æ¬¢è¿æ¶ˆæ¯
                const messages = document.querySelectorAll('.message');
                messages.forEach(msg => {
                    if (!msg.closest('.welcome-container')) {
                        msg.remove();
                    }
                });
                
                userInput.value = '';
                userInput.style.height = '48px';
                sendBtn.disabled = true;
                
                // æ»šåŠ¨åˆ°é¡¶éƒ¨æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                chatContentContainer.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                
                // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
                if (robotAssistant) {
                    robotAssistant.showMessage('å·²å¼€å§‹æ–°çš„å¯¹è¯', 2000);
                }
            }
        }
        
        // å¤„ç†å¿«æ·æ“ä½œ
        function handleQuickAction() {
            const action = this.textContent.trim();
            const prompts = {
                'å£è¯­ç»ƒä¹ ': 'æˆ‘æƒ³ç»ƒä¹ è‹±è¯­å£è¯­ï¼Œè¯·æ¨¡æ‹Ÿä¸€ä¸ªæ—¥å¸¸å¯¹è¯åœºæ™¯ï¼Œæ¯”å¦‚åœ¨å’–å•¡åº—ç‚¹é¤ã€‚',
                'è¯­æ³•æ£€æŸ¥': 'è¯·å¸®æˆ‘æ£€æŸ¥ä»¥ä¸‹è‹±æ–‡å¥å­çš„è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼Œå¹¶æŒ‡å‡ºé”™è¯¯ï¼š',
                'æ–‡æœ¬ç¿»è¯‘': 'è¯·å°†ä»¥ä¸‹ä¸­æ–‡ç¿»è¯‘æˆè‹±æ–‡ï¼š',
                'å­¦ä¹ è®¡åˆ’': 'æˆ‘éœ€è¦ä¸€ä¸ªä¸ºæœŸ30å¤©çš„è‹±è¯­å­¦ä¹ è®¡åˆ’ï¼Œç›®æ ‡æ˜¯æå‡å•†åŠ¡è‹±è¯­èƒ½åŠ›ã€‚'
            };
            
            userInput.value = prompts[action] || action;
            userInput.focus();
            sendBtn.disabled = false;
            userInput.style.height = 'auto';
            userInput.style.height = (userInput.scrollHeight) + 'px';
            
            // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
            if (robotAssistant) {
                robotAssistant.showMessage(`å‡†å¤‡${action}...`, 1500);
            }
        }
        
        // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        function showFileModal() {
            fileModal.classList.remove('hidden');
            
            // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
            if (robotAssistant) {
                robotAssistant.showMessage('å¯ä»¥ä¸Šä¼ æ–‡ä»¶ç»™æˆ‘åˆ†æå“¦', 2000);
            }
        }

        function hideFileModal() {
            fileModal.classList.add('hidden');
            fileUpload.value = '';
            filePreview.classList.add('hidden');
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length === 0) return;

            fileList.innerHTML = '';
            for (let i = 0; i < files.length; i++) {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between py-1';
                fileItem.innerHTML = `
                    <span class="truncate flex-1">${files[i].name}</span>
                    <span class="text-xs text-gray-500 ml-2">${formatFileSize(files[i].size)}</span>
                `;
                fileList.appendChild(fileItem);
            }

            filePreview.classList.remove('hidden');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function handleFileUpload() {
            const files = fileUpload.files;
            if (files.length === 0) return;

            hideFileModal();

            // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
            const uploadStatus = document.createElement('div');
            uploadStatus.className = 'flex gap-3 message';
            uploadStatus.innerHTML = `
                <div class="flex-shrink-0">
                    <img src="https://imgur.la/images/2025/05/25/5DC7B90094E838CB7FF1A4EA6EE289BF.jpg" class="w-10 h-10 rounded-full" alt="ç”¨æˆ·å¤´åƒ">
                </div>
                <div class="flex-1 flex justify-end">
                    <div class="message-user p-4 shadow-message">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-spinner spinner"></i>
                            <span>æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...</span>
                        </div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(uploadStatus);
            scrollToBottom();

            try {
                // æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¿‡ç¨‹
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // æ›´æ–°ä¸Šä¼ çŠ¶æ€ä¸ºå®Œæˆ
                uploadStatus.querySelector('.fa-spinner').classList.replace('fa-spinner', 'fa-check');
                uploadStatus.querySelector('span').textContent = `å·²ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶`;
                
                // æ·»åŠ æ–‡ä»¶ä¿¡æ¯åˆ°èŠå¤©
                let fileInfo = 'æˆ‘å·²ä¸Šä¼ ä»¥ä¸‹æ–‡ä»¶ï¼š\n';
                for (let i = 0; i < files.length; i++) {
                    fileInfo += `â€¢ ${files[i].name} (${formatFileSize(files[i].size)})\n`;
                }
                
                // æ›¿æ¢ä¸Šä¼ çŠ¶æ€ä¸ºå®é™…æ–‡ä»¶ä¿¡æ¯
                uploadStatus.querySelector('.message-user').innerHTML = `
                    <p class="font-content text-white">${fileInfo.replace(/\n/g, '<br>')}</p>
                `;
                
                // å¦‚æœæ˜¯å›¾ç‰‡æ–‡ä»¶ï¼Œæ˜¾ç¤ºé¢„è§ˆ
                const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                if (imageFiles.length > 0) {
                    const imagePreview = document.createElement('div');
                    imagePreview.className = 'mt-2 grid grid-cols-2 gap-2';
                    
                    for (let i = 0; i < Math.min(imageFiles.length, 4); i++) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'rounded-lg max-w-full h-auto';
                            imagePreview.appendChild(img);
                        };
                        reader.readAsDataURL(imageFiles[i]);
                    }
                    
                    uploadStatus.querySelector('.message-user').appendChild(imagePreview);
                }
                
                // è°ƒç”¨APIå¤„ç†æ–‡ä»¶å†…å®¹
                if (files.length === 1 && files[0].type === 'text/plain') {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        const fileContent = e.target.result;
                        const typingIndicator = showTypingIndicator();
                        
                        try {
                            // å°†æ–‡ä»¶å†…å®¹æ·»åŠ åˆ°å¯¹è¯å†å²
                            conversationHistory.push({
                                role: "user",
                                content: `è¯·åˆ†æä»¥ä¸‹æ–‡ä»¶å†…å®¹ï¼š\n${fileContent.substring(0, 2000)}`
                            });
                            
                            const aiResponse = await callZhipuAPI();
                            removeTypingIndicator(typingIndicator);
                            addMessage(aiResponse, 'ai');
                            
                            // å°†AIå›å¤æ·»åŠ åˆ°å¯¹è¯å†å²
                            conversationHistory.push({
                                role: "assistant",
                                content: aiResponse
                            });
                            
                            // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
                            if (robotAssistant) {
                                robotAssistant.showMessage('æ–‡ä»¶åˆ†æå®Œæˆ', 1500);
                            }
                        } catch (error) {
                            removeTypingIndicator(typingIndicator);
                            addMessage("ğŸ˜… æŠ±æ­‰ï¼Œå¤„ç†æ–‡ä»¶å†…å®¹æ—¶å‡ºé”™ï¼š" + error.message, 'ai');
                            
                            // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
                            if (robotAssistant) {
                                robotAssistant.showMessage('å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™', 1500);
                            }
                        }
                    };
                    reader.readAsText(files[0]);
                }
            } catch (error) {
                uploadStatus.querySelector('.fa-spinner').classList.replace('fa-spinner', 'fa-times');
                uploadStatus.querySelector('span').textContent = 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥';
                console.error("æ–‡ä»¶ä¸Šä¼ é”™è¯¯:", error);
                
                // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
                if (robotAssistant) {
                    robotAssistant.showMessage('ä¸Šä¼ å¤±è´¥', 1500);
                }
            }
        }

        // è¯­éŸ³è¾“å…¥åŠŸèƒ½
        function toggleVoiceInput() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨');
                
                // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
                if (robotAssistant) {
                    robotAssistant.showMessage('ä¸æ”¯æŒè¯­éŸ³è¾“å…¥', 1500);
                }
                return;
            }

            if (recognition && recognition.isListening) {
                stopVoiceRecognition();
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                
                // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
                if (robotAssistant) {
                    robotAssistant.showMessage('è¯­éŸ³è¾“å…¥å·²å…³é—­', 1500);
                }
                return;
            }

            startVoiceRecognition();
            voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            
            // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
            if (robotAssistant) {
                robotAssistant.showMessage('æ­£åœ¨è†å¬...', 1500);
            }
        }

        function startVoiceRecognition() {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'zh-CN';

            recognition.onstart = function() {
                console.log('è¯­éŸ³è¯†åˆ«å¼€å§‹');
            };

            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (finalTranscript) {
                    userInput.value = finalTranscript;
                    handleInputChange.call(userInput);
                    
                    // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
                    if (robotAssistant) {
                        robotAssistant.showMessage('è¯†åˆ«å®Œæˆ', 1000);
                    }
                } else if (interimTranscript) {
                    userInput.value = interimTranscript;
                    handleInputChange.call(userInput);
                }
            };

            recognition.onerror = function(event) {
                console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                stopVoiceRecognition();
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                
                // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
                if (robotAssistant) {
                    robotAssistant.showMessage('è¯†åˆ«å‡ºé”™', 1500);
                }
            };

            recognition.onend = function() {
                console.log('è¯­éŸ³è¯†åˆ«ç»“æŸ');
                stopVoiceRecognition();
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            };

            recognition.start();
            recognition.isListening = true;
        }

        function stopVoiceRecognition() {
            if (recognition) {
                recognition.stop();
                recognition.isListening = false;
            }
        }

        // èŠå¤©å†å²åŠŸèƒ½
        function saveChatToHistory(userMessage, aiResponse) {
            const chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '{}');

            if (!chatHistory[currentChatId]) {
                chatHistory[currentChatId] = {
                    id: currentChatId,
                    title: userMessage.substring(0, 30) + (userMessage.length > 30 ? '...' : ''),
                    preview: aiResponse.substring(0, 50) + (aiResponse.length > 50 ? '...' : ''),
                    timestamp: Date.now(),
                    messages: [],
                    assistantType: currentAssistant
                };
            }

            chatHistory[currentChatId].messages.push({
                user: userMessage,
                ai: aiResponse,
                timestamp: Date.now()
            });

            // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
            chatHistory[currentChatId].timestamp = Date.now();

            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            updateChatHistoryUI(chatHistory);
            
            // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
            if (robotAssistant) {
                robotAssistant.showMessage('å¯¹è¯å·²ä¿å­˜', 1500);
            }
        }

        function loadChatHistory() {
            const chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '{}');
            updateChatHistoryUI(chatHistory);
        }

        function updateChatHistoryUI(chatHistory) {
            chatHistoryList.innerHTML = '';

            const sortedChats = Object.values(chatHistory).sort((a, b) => b.timestamp - a.timestamp);

            if (sortedChats.length === 0) {
                chatHistoryList.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <p>æš‚æ— å†å²å¯¹è¯</p>
                    </div>
                `;
                return;
            }

            sortedChats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'p-3 rounded-lg bg-gray-50/80 hover:bg-gray-100/90 cursor-pointer backdrop-blur-sm border border-gray-100/20';
                chatItem.dataset.chatId = chat.id;
                
                const timeAgo = formatTimeAgo(chat.timestamp);
                
                chatItem.innerHTML = `
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium text-gray-900">${chat.title}</span>
                        <span class="text-xs text-gray-500">${timeAgo}</span>
                    </div>
                    <p class="text-xs text-gray-500 truncate">${chat.preview}</p>
                    <div class="mt-1 flex items-center">
                        <span class="text-xs text-gray-400">${getAssistantIcon(chat.assistantType || 'learning')}</span>
                    </div>
                `;
                
                chatItem.addEventListener('click', () => loadChatFromHistory(chat.id));
                chatHistoryList.appendChild(chatItem);
            });
        }

        function getAssistantIcon(assistantType) {
            const icons = {
                'learning': '<i class="fas fa-graduation-cap text-xs mr-1"></i>å­¦ä¹ åŠ©æ‰‹',
                'translation': '<i class="fas fa-language text-xs mr-1"></i>ç¿»è¯‘åŠ©æ‰‹',
                'writing': '<i class="fas fa-pen text-xs mr-1"></i>å†™ä½œåŠ©æ‰‹'
            };
            return icons[assistantType] || icons['learning'];
        }

        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);

            if (seconds < 60) return 'åˆšåˆš';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}åˆ†é’Ÿå‰`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}å°æ—¶å‰`;
            return `${Math.floor(seconds / 86400)}å¤©å‰`;
        }

        function loadChatFromHistory(chatId) {
            if (typeof chatId !== 'string') {
                chatId = this.dataset.chatId;
            }

            const chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '{}');
            const chat = chatHistory[chatId];

            if (!chat) return;

            // è®¾ç½®å½“å‰å¯¹è¯IDå’ŒåŠ©æ‰‹ç±»å‹
            currentChatId = chatId;
            currentAssistant = chat.assistantType || 'learning';
            
            // æ›´æ–°UIæ˜¾ç¤ºå½“å‰åŠ©æ‰‹
            switchAssistant(currentAssistant);

            // é‡ç½®å¯¹è¯å†å²
            conversationHistory = [
                {
                    role: "system",
                    content: getSystemPrompt(currentAssistant)
                }
            ];

            // æ¸…é™¤ç°æœ‰èŠå¤©å†…å®¹
            const messages = document.querySelectorAll('.message');
            messages.forEach(msg => {
                if (!msg.closest('.welcome-container')) {
                    msg.remove();
                }
            });

            // æ·»åŠ å†å²æ¶ˆæ¯å¹¶é‡å»ºå¯¹è¯å†å²
            chat.messages.forEach(msg => {
                addMessage(msg.user, 'user');
                addMessage(msg.ai, 'ai');
                
                // é‡å»ºå¯¹è¯å†å²
                conversationHistory.push({
                    role: "user",
                    content: msg.user
                });
                conversationHistory.push({
                    role: "assistant",
                    content: msg.ai
                });
            });

            // å…³é—­ä¾§è¾¹æ ï¼ˆå¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ï¼‰
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
            
            // è§¦å‘æœºæ¢°äººåŠ©æ‰‹åé¦ˆ
            if (robotAssistant) {
                robotAssistant.showMessage('å·²åŠ è½½å†å²å¯¹è¯', 1500);
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>